---
import { baiduAnalyticsConfig } from '@/config';
import { getSiteOverview, getLast7DaysRange } from '@/utils/baidu-analytics';

interface Props {
  showStats?: boolean;
  className?: string;
}

const { showStats = false, className = '' } = Astro.props;

let statsData = null;
let error = null;

// åªåœ¨å¯ç”¨ç»Ÿè®¡ä¸”éœ€è¦æ˜¾ç¤ºæ•°æ®æ—¶è·å–
if (baiduAnalyticsConfig.enable && showStats && baiduAnalyticsConfig.siteId) {
  try {
    if (typeof window !== 'undefined' && 'requestIdleCallback' in window) {
      await new Promise(resolve => {
        window.requestIdleCallback(resolve);
      });
    } else {
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    const { startDate, endDate } = getLast7DaysRange();
    statsData = await getSiteOverview(baiduAnalyticsConfig.siteId, startDate, endDate);
  } catch (err) {
    error = err instanceof Error ? err.message : 'è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥';
    console.error('ç™¾åº¦ç»Ÿè®¡æ•°æ®è·å–å¤±è´¥:', err);
  }
}
---

{showStats && baiduAnalyticsConfig.enable && (
  <div class={`baidu-analytics ${className}`}>
    {error ? (
      <div class="analytics-error">
        <p class="text-red-500 text-sm">ğŸ“Š ç»Ÿè®¡æ•°æ®æš‚æ—¶æ— æ³•åŠ è½½</p>
        <p class="text-gray-500 text-xs">{error}</p>
      </div>
    ) : statsData ? (
      <div class="analytics-stats">
        <h3 class="text-lg font-semibold mb-3">ğŸ“Š ç½‘ç«™ç»Ÿè®¡</h3>
        <div class="stats-grid grid grid-cols-1 md:grid-cols-3 gap-4">
          {statsData.data && statsData.data[0] && (
            <>
              <div class="stat-item bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                <div class="stat-label text-sm text-gray-600 dark:text-gray-400">é¡µé¢æµè§ˆé‡</div>
                <div class="stat-value text-2xl font-bold text-blue-600 dark:text-blue-400">
                  {statsData.data[0][0]?.toLocaleString() || '0'}
                </div>
              </div>
              <div class="stat-item bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                <div class="stat-label text-sm text-gray-600 dark:text-gray-400">è®¿å®¢æ•°</div>
                <div class="stat-value text-2xl font-bold text-green-600 dark:text-green-400">
                  {statsData.data[0][1]?.toLocaleString() || '0'}
                </div>
              </div>
              <div class="stat-item bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg">
                <div class="stat-label text-sm text-gray-600 dark:text-gray-400">IPæ•°</div>
                <div class="stat-value text-2xl font-bold text-purple-600 dark:text-purple-400">
                  {statsData.data[0][2]?.toLocaleString() || '0'}
                </div>
              </div>
            </>
          )}
        </div>
        <p class="text-xs text-gray-500 mt-3">æ•°æ®æ¥æºï¼šç™¾åº¦ç»Ÿè®¡ï¼ˆæœ€è¿‘7å¤©ï¼‰</p>
      </div>
    ) : (
      <div class="analytics-loading">
        <p class="text-gray-500 text-sm">ğŸ“Š æ­£åœ¨åŠ è½½ç»Ÿè®¡æ•°æ®...</p>
      </div>
    )}
  </div>
)}

<style>
.baidu-analytics {
  @apply mb-6;
}

.stats-grid {
  @apply transition-all duration-300;
}

.stat-item {
  @apply transform hover:scale-105 transition-transform duration-200;
}

.stat-value {
  @apply font-mono;
}

.analytics-error {
  @apply p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800;
}

.analytics-loading {
  @apply p-4 bg-gray-50 dark:bg-gray-800 rounded-lg animate-pulse;
}
</style>