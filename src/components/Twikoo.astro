---
import { twikooConfig } from "../config";

interface Props {
	class?: string;
}

const { class: className } = Astro.props;

// å¦‚æœè¯„è®ºç³»ç»Ÿæœªå¯ç”¨ï¼Œåˆ™ä¸æ¸²æŸ“
if (!twikooConfig.enable) {
	return null;
}
---

{twikooConfig.enable && (
	<div class:list={["twikoo-container", className]}>
		<div id="tcomment">
			<div style="text-align: center; padding: 2rem; color: var(--content-text-color);">
				æ­£åœ¨åŠ è½½è¯„è®ºç³»ç»Ÿ...
			</div>
		</div>
	</div>
)}

<style>
	.twikoo-container {
		margin-top: 2rem;
		padding: 1rem 0;
	}
	
	/* Twikoo æ ·å¼è‡ªå®šä¹‰ */
	:global(.twikoo) {
		--tw-bg-color: var(--card-bg);
		--tw-text-color: var(--content-text-color);
		--tw-border-color: var(--line-divider);
		--tw-primary-color: var(--primary);
		font-family: inherit;
	}
	
	/* é€‚é…æš—è‰²ä¸»é¢˜ */
	:global(.dark .twikoo) {
		--tw-bg-color: var(--card-bg);
		--tw-text-color: var(--content-text-color);
		--tw-border-color: var(--line-divider);
	}
	
	/* è‡ªå®šä¹‰ Twikoo ç»„ä»¶æ ·å¼ */
	:global(.twikoo .tk-submit) {
		background-color: var(--primary) !important;
		border-color: var(--primary) !important;
		border-radius: 1rem !important;
		transition: all 0.2s ease;
	}
	
	:global(.twikoo .tk-submit:hover) {
		opacity: 0.8;
		transform: translateY(-1px);
	}
	
	/* è¾“å…¥æ¡†åœ†æ¶¦è¾¹æ¡† */
	:global(.twikoo .tk-input),
	:global(.twikoo .tk-textarea) {
		background-color: var(--card-bg) !important;
		border-color: var(--line-divider) !important;
		color: var(--content-text-color) !important;
		border-radius: 1rem !important;
	}
	
	/* è¯„è®ºå®¹å™¨åœ†æ¶¦è¾¹æ¡† */
	:global(.twikoo .tk-comments-container) {
		background-color: transparent !important;
	}
	
	:global(.twikoo .tk-comment) {
		border-color: var(--line-divider) !important;
		background-color: var(--card-bg) !important;
		border-radius: 1.25rem !important;
	}
	
	/* å¤´åƒåœ†æ¶¦è¾¹æ¡† */
	:global(.twikoo .tk-avatar) {
		border-radius: 1rem !important;
	}
	
	/* å…¶ä»–æŒ‰é’®åœ†æ¶¦è¾¹æ¡† */
	:global(.twikoo .tk-cancel),
	:global(.twikoo .tk-reply),
	:global(.twikoo .tk-action-icon) {
		border-radius: 0.75rem !important;
	}
	
	/* è¡¨å•åŒºåŸŸåœ†æ¶¦è¾¹æ¡† */
	:global(.twikoo .tk-row) {
		border-radius: 1rem !important;
	}
	
	/* å…ƒä¿¡æ¯è¾“å…¥åŒºåŸŸåœ†æ¶¦è¾¹æ¡† */
	:global(.twikoo .tk-meta-input) {
		border-radius: 1rem !important;
	}
</style>

<!-- ä½¿ç”¨å¤šä¸ªCDNæºç¡®ä¿åŠ è½½ç¨³å®šæ€§ -->
<script>
	// å°è¯•å¤šä¸ªCDNæºåŠ è½½Twikoo
	const cdnSources = [
		'https://cdn.staticfile.org/twikoo/1.6.44/twikoo.min.js',
		'https://registry.npmmirror.com/twikoo/1.6.44/files/dist/twikoo.min.js',
		'https://unpkg.com/twikoo@1.6.44/dist/twikoo.min.js'
	];
	
	let currentCdnIndex = 0;
	
	function loadTwikooScript() {
		if (currentCdnIndex >= cdnSources.length) {
			console.error('æ‰€æœ‰CDNæºéƒ½åŠ è½½å¤±è´¥');
			handleScriptLoadError();
			return;
		}
		
		const script = document.createElement('script');
		script.src = cdnSources[currentCdnIndex];
		script.onload = function() {
			console.log(`Twikooè„šæœ¬ä»CDN ${currentCdnIndex + 1} åŠ è½½æˆåŠŸ`);
		};
		script.onerror = function() {
			console.warn(`CDN ${currentCdnIndex + 1} åŠ è½½å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª`);
			currentCdnIndex++;
			loadTwikooScript();
		};
		document.head.appendChild(script);
	}
	
	function handleScriptLoadError() {
		const container = document.getElementById('tcomment');
		if (container) {
			container.innerHTML = `
				<div style="text-align: center; padding: 2rem; color: var(--content-text-color); border: 1px dashed var(--line-divider); border-radius: 12px; background: var(--card-bg);">
					<p style="margin-bottom: 0.5rem;">ğŸ’¬ è¯„è®ºç³»ç»Ÿè„šæœ¬åŠ è½½å¤±è´¥</p>
					<p style="font-size: 0.875rem; opacity: 0.7;">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</p>
				</div>
			`;
		}
	}
	
	// å¼€å§‹åŠ è½½è„šæœ¬
	loadTwikooScript();
</script>

<script define:vars={{ twikooConfig }}>
	// å…¨å±€å˜é‡å­˜å‚¨é…ç½®
	window.twikooConfigGlobal = twikooConfig;
	
	// ç­‰å¾…Twikooè„šæœ¬åŠ è½½å®Œæˆååˆå§‹åŒ–
	function waitForTwikooAndInit() {
		let attempts = 0;
		const maxAttempts = 20; // æœ€å¤šç­‰å¾…10ç§’
		
		function checkAndInit() {
			attempts++;
			
			// æ£€æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨
			const container = document.getElementById('tcomment');
			if (!container) {
				console.error('Twikoo å®¹å™¨æœªæ‰¾åˆ°');
				return;
			}

			// æ£€æŸ¥ Twikoo æ˜¯å¦åŠ è½½
			if (typeof window.twikoo !== 'undefined') {
				console.log('Twikoo è„šæœ¬å·²åŠ è½½ï¼Œå¼€å§‹åˆå§‹åŒ–');
				initTwikoo();
			} else if (attempts < maxAttempts) {
				console.log(`ç­‰å¾…Twikooè„šæœ¬åŠ è½½... (${attempts}/${maxAttempts})`);
				setTimeout(checkAndInit, 500);
			} else {
				console.error('Twikoo è„šæœ¬åŠ è½½è¶…æ—¶');
				handleError(new Error('Twikoo è„šæœ¬åŠ è½½è¶…æ—¶'));
			}
		}
		
		checkAndInit();
	}

	// åˆå§‹åŒ– Twikoo
	function initTwikoo() {
		const container = document.getElementById('tcomment');
		if (!container) {
			console.error('Twikoo å®¹å™¨æœªæ‰¾åˆ°');
			return;
		}

		try {
			console.log('å¼€å§‹åˆå§‹åŒ–Twikooï¼Œç¯å¢ƒID:', window.twikooConfigGlobal.envId);
			
			window.twikoo.init({
				envId: window.twikooConfigGlobal.envId,
				el: '#tcomment',
				path: location.pathname,
				lang: 'zh-CN',
				onCommentLoaded: function () {
					console.log('Twikoo è¯„è®ºåŠ è½½å®Œæˆ');
				},
				onError: function (error) {
					console.error('Twikoo åˆå§‹åŒ–é”™è¯¯:', error);
					handleError(error);
				}
			}).catch(error => {
				console.error('Twikoo init promise é”™è¯¯:', error);
				handleError(error);
			});
		} catch (error) {
			console.error('Twikoo åˆå§‹åŒ–å¼‚å¸¸:', error);
			handleError(error);
		}
	}

	function handleError(error) {
		console.error('Twikoo é”™è¯¯:', error);
		const container = document.getElementById('tcomment');
		if (container) {
			container.innerHTML = `
				<div style="text-align: center; padding: 2rem; color: var(--content-text-color); border: 1px dashed var(--line-divider); border-radius: 12px; background: var(--card-bg);">
					<p style="margin-bottom: 0.5rem;">ğŸ’¬ è¯„è®ºç³»ç»Ÿæš‚æ—¶æ— æ³•åŠ è½½</p>
					<p style="font-size: 0.875rem; opacity: 0.7;">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</p>
					<p style="font-size: 0.75rem; opacity: 0.5; margin-top: 1rem;">ç¯å¢ƒID: ${window.twikooConfigGlobal.envId}</p>
					<button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 0.5rem; cursor: pointer;">é‡æ–°åŠ è½½</button>
				</div>
			`;
		}
	}

	// é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹ç­‰å¾…å’Œåˆå§‹åŒ–
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', waitForTwikooAndInit);
	} else {
		waitForTwikooAndInit();
	}

	// æ”¯æŒ Swup é¡µé¢åˆ‡æ¢
	const setup = () => {
		window.swup?.hooks.on('page:view', () => {
			const container = document.getElementById('tcomment');
			if (container) {
				container.innerHTML = '<div style="text-align: center; padding: 1rem; color: var(--content-text-color);">æ­£åœ¨åŠ è½½è¯„è®ºç³»ç»Ÿ...</div>';
				setTimeout(waitForTwikooAndInit, 300);
			}
		});
	};

	if (window?.swup?.hooks) {
		setup();
	} else {
		document.addEventListener('swup:enable', setup);
	}
</script>