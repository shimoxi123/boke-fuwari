---
import { twikooConfig } from "../config";

interface Props {
	class?: string;
}

const { class: className } = Astro.props;

// å¦‚æœè¯„è®ºç³»ç»Ÿæœªå¯ç”¨ï¼Œåˆ™ä¸æ¸²æŸ“
if (!twikooConfig.enable) {
	return null;
}
---

{twikooConfig.enable && (
	<div class:list={["twikoo-container", className]}>
		{twikooConfig.lazyLoad ? (
			<!-- æ‡’åŠ è½½æ¨¡å¼ -->
			<>
				<!-- æ‡’åŠ è½½è§¦å‘æŒ‰é’® -->
				<div id="twikoo-trigger" class="twikoo-trigger">
					<button class="load-comments-btn" onclick="loadTwikoo()">
						ğŸ’¬ åŠ è½½è¯„è®º
					</button>
					<p class="load-hint">ç‚¹å‡»åŠ è½½è¯„è®ºç³»ç»Ÿ</p>
				</div>
				
				<!-- è¯„è®ºå®¹å™¨ -->
				<div id="tcomment" style="display: none;">
					<div class="loading-placeholder">
						<div class="loading-spinner"></div>
						<p>æ­£åœ¨åŠ è½½è¯„è®ºç³»ç»Ÿ...</p>
					</div>
				</div>
			</>
		) : (
			<!-- ç›´æ¥åŠ è½½æ¨¡å¼ -->
			<div id="tcomment">
				<div class="loading-placeholder">
					<div class="loading-spinner"></div>
					<p>æ­£åœ¨åŠ è½½è¯„è®ºç³»ç»Ÿ...</p>
				</div>
			</div>
		)}
	</div>
)}

<style>
	.twikoo-container {
		margin-top: 1.5rem;
	}
	
	/* ç®€æ´çš„æ‡’åŠ è½½æŒ‰é’® */
	.twikoo-trigger {
		text-align: center;
		padding: 1.5rem;
		border: 1px solid var(--line-divider);
		border-radius: 8px;
		transition: border-color 0.2s ease;
	}
	
	.twikoo-trigger:hover {
		border-color: var(--primary);
	}
	
	.load-comments-btn {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		padding: 0.5rem 1rem;
		background: transparent;
		color: var(--primary);
		border: 1px solid var(--primary);
		border-radius: 6px;
		font-size: 0.9rem;
		cursor: pointer;
		transition: all 0.2s ease;
	}
	
	.load-comments-btn:hover {
		background: var(--primary);
		color: white;
	}
	
	.load-hint {
		margin: 0.5rem 0 0 0;
		font-size: 0.8rem;
		color: var(--content-text-color);
		opacity: 0.6;
	}
	
	/* ç®€æ´çš„åŠ è½½çŠ¶æ€ */
	.loading-placeholder {
		text-align: center;
		padding: 1.5rem;
		color: var(--content-text-color);
		opacity: 0.7;
	}
	
	.loading-spinner {
		width: 20px;
		height: 20px;
		border: 2px solid var(--line-divider);
		border-top: 2px solid var(--primary);
		border-radius: 50%;
		animation: spin 1s linear infinite;
		margin: 0 auto 0.5rem;
	}
	
	@keyframes spin {
		0% { transform: rotate(0deg); }
		100% { transform: rotate(360deg); }
	}
	
	/* æœ€ç®€åŒ–çš„ Twikoo æ ·å¼ */
	:global(.twikoo) {
		font-family: inherit;
	}
</style>

<!-- è¯„è®ºç³»ç»Ÿè„šæœ¬ -->
<script define:vars={{ twikooConfig }} is:inline>
	// å…¨å±€å˜é‡å­˜å‚¨é…ç½®
	window.twikooConfigGlobal = twikooConfig;
	window.twikooLoaded = false;
	window.twikooLoading = false;

	// æ‡’åŠ è½½å‡½æ•° - ç”¨æˆ·ç‚¹å‡»æ—¶è°ƒç”¨
	window.loadTwikoo = function() {
		if (window.twikooLoading || window.twikooLoaded) return;
		loadTwikooScript();
	};

	// åŠ è½½Twikooè„šæœ¬
	function loadTwikooScript() {
		window.twikooLoading = true;
		
		// å¦‚æœæ˜¯æ‡’åŠ è½½æ¨¡å¼ï¼Œéšè—è§¦å‘æŒ‰é’®ï¼Œæ˜¾ç¤ºè¯„è®ºå®¹å™¨
		if (twikooConfig.lazyLoad) {
			const trigger = document.getElementById('twikoo-trigger');
			const container = document.getElementById('tcomment');
			if (trigger) trigger.style.display = 'none';
			if (container) container.style.display = 'block';
		}
		
		// åŠ è½½Twikooè„šæœ¬
		const script = document.createElement('script');
		script.src = 'https://cdn.staticfile.org/twikoo/1.6.44/twikoo.min.js';
		script.onload = function() {
			console.log('Twikooè„šæœ¬åŠ è½½æˆåŠŸ');
			initTwikoo();
		};
		script.onerror = function() {
			console.warn('ä¸»CDNåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨CDN');
			loadBackupTwikoo();
		};
		document.head.appendChild(script);
	}

	// å¤‡ç”¨CDNåŠ è½½
	function loadBackupTwikoo() {
		const script = document.createElement('script');
		script.src = 'https://unpkg.com/twikoo@1.6.44/dist/twikoo.min.js';
		script.onload = function() {
			console.log('Twikooå¤‡ç”¨è„šæœ¬åŠ è½½æˆåŠŸ');
			initTwikoo();
		};
		script.onerror = function() {
			showError('è¯„è®ºç³»ç»ŸåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
		};
		document.head.appendChild(script);
	}

	// åˆå§‹åŒ–Twikoo
	function initTwikoo() {
		if (typeof window.twikoo === 'undefined') {
			showError('Twikooè„šæœ¬åŠ è½½å¤±è´¥');
			return;
		}

		try {
			window.twikoo.init({
				envId: window.twikooConfigGlobal.envId,
				el: '#tcomment',
				path: location.pathname,
				lang: window.twikooConfigGlobal.lang || 'zh-CN'
			}).then(() => {
				console.log('Twikooåˆå§‹åŒ–æˆåŠŸ');
				window.twikooLoaded = true;
				window.twikooLoading = false;
			}).catch(error => {
				console.error('Twikooåˆå§‹åŒ–å¤±è´¥:', error);
				showError('è¯„è®ºç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥');
			});
		} catch (error) {
			console.error('Twikooåˆå§‹åŒ–å¼‚å¸¸:', error);
			showError('è¯„è®ºç³»ç»Ÿåˆå§‹åŒ–å¼‚å¸¸');
		}
	}

	// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
	function showError(message) {
		const container = document.getElementById('tcomment');
		if (container) {
			container.innerHTML = `
				<div style="text-align: center; padding: 2rem; color: var(--content-text-color); border: 1px dashed var(--line-divider); border-radius: 12px; background: var(--card-bg);">
					<p style="margin-bottom: 0.5rem;">ğŸ’¬ ${message}</p>
					<button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">é‡æ–°åŠ è½½</button>
				</div>
			`;
		}
		window.twikooLoading = false;
	}

	// é¡µé¢åŠ è½½å®Œæˆåçš„å¤„ç†
	function handlePageLoad() {
		// å¦‚æœä¸æ˜¯æ‡’åŠ è½½æ¨¡å¼ï¼Œç›´æ¥åŠ è½½è¯„è®ºç³»ç»Ÿ
		if (!twikooConfig.lazyLoad) {
			loadTwikooScript();
		}
	}

	// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', handlePageLoad);
	} else {
		handlePageLoad();
	}

	// æ”¯æŒé¡µé¢åˆ‡æ¢æ—¶é‡ç½®çŠ¶æ€
	const setupSwup = () => {
		window.swup?.hooks.on('page:view', () => {
			window.twikooLoaded = false;
			window.twikooLoading = false;
			// é‡æ–°å¤„ç†é¡µé¢åŠ è½½
			setTimeout(handlePageLoad, 100);
		});
	};

	if (window?.swup?.hooks) {
		setupSwup();
	} else {
		document.addEventListener('swup:enable', setupSwup);
	}
</script>