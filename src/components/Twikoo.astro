---
import { twikooConfig } from "../config";

interface Props {
	class?: string;
}

const { class: className } = Astro.props;

// 如果评论系统未启用，则不渲染
if (!twikooConfig.enable) {
	return null;
}
---

{twikooConfig.enable && (
	<div class:list={["twikoo-container", className]}>
		<div id="tcomment">
			<div style="text-align: center; padding: 2rem; color: var(--content-text-color);">
				正在加载评论系统...
			</div>
		</div>
	</div>
)}

<style>
	.twikoo-container {
		margin-top: 2rem;
		padding: 1rem 0;
	}
	
	/* Twikoo 样式自定义 */
	:global(.twikoo) {
		--tw-bg-color: var(--card-bg);
		--tw-text-color: var(--content-text-color);
		--tw-border-color: var(--line-divider);
		--tw-primary-color: var(--primary);
		font-family: inherit;
	}
	
	/* 适配暗色主题 */
	:global(.dark .twikoo) {
		--tw-bg-color: var(--card-bg);
		--tw-text-color: var(--content-text-color);
		--tw-border-color: var(--line-divider);
	}
	
	/* 自定义 Twikoo 组件样式 */
	:global(.twikoo .tk-submit) {
		background-color: var(--primary) !important;
		border-color: var(--primary) !important;
		border-radius: 1rem !important;
		transition: all 0.2s ease;
	}
	
	:global(.twikoo .tk-submit:hover) {
		opacity: 0.8;
		transform: translateY(-1px);
	}
	
	/* 输入框圆润边框 */
	:global(.twikoo .tk-input),
	:global(.twikoo .tk-textarea) {
		background-color: var(--card-bg) !important;
		border-color: var(--line-divider) !important;
		color: var(--content-text-color) !important;
		border-radius: 1rem !important;
	}
	
	/* 评论容器圆润边框 */
	:global(.twikoo .tk-comments-container) {
		background-color: transparent !important;
	}
	
	:global(.twikoo .tk-comment) {
		border-color: var(--line-divider) !important;
		background-color: var(--card-bg) !important;
		border-radius: 1.25rem !important;
	}
	
	/* 头像圆润边框 */
	:global(.twikoo .tk-avatar) {
		border-radius: 1rem !important;
	}
	
	/* 其他按钮圆润边框 */
	:global(.twikoo .tk-cancel),
	:global(.twikoo .tk-reply),
	:global(.twikoo .tk-action-icon) {
		border-radius: 0.75rem !important;
	}
	
	/* 表单区域圆润边框 */
	:global(.twikoo .tk-row) {
		border-radius: 1rem !important;
	}
	
	/* 元信息输入区域圆润边框 */
	:global(.twikoo .tk-meta-input) {
		border-radius: 1rem !important;
	}
</style>

<!-- 使用多个CDN源确保加载稳定性 -->
<script>
	// 尝试多个CDN源加载Twikoo
	const cdnSources = [
		'https://cdn.staticfile.org/twikoo/1.6.44/twikoo.min.js',
		'https://registry.npmmirror.com/twikoo/1.6.44/files/dist/twikoo.min.js',
		'https://unpkg.com/twikoo@1.6.44/dist/twikoo.min.js'
	];
	
	let currentCdnIndex = 0;
	
	function loadTwikooScript() {
		if (currentCdnIndex >= cdnSources.length) {
			console.error('所有CDN源都加载失败');
			handleScriptLoadError();
			return;
		}
		
		const script = document.createElement('script');
		script.src = cdnSources[currentCdnIndex];
		script.onload = function() {
			console.log(`Twikoo脚本从CDN ${currentCdnIndex + 1} 加载成功`);
		};
		script.onerror = function() {
			console.warn(`CDN ${currentCdnIndex + 1} 加载失败，尝试下一个`);
			currentCdnIndex++;
			loadTwikooScript();
		};
		document.head.appendChild(script);
	}
	
	function handleScriptLoadError() {
		const container = document.getElementById('tcomment');
		if (container) {
			container.innerHTML = `
				<div style="text-align: center; padding: 2rem; color: var(--content-text-color); border: 1px dashed var(--line-divider); border-radius: 12px; background: var(--card-bg);">
					<p style="margin-bottom: 0.5rem;">💬 评论系统脚本加载失败</p>
					<p style="font-size: 0.875rem; opacity: 0.7;">请检查网络连接或稍后重试</p>
				</div>
			`;
		}
	}
	
	// 开始加载脚本
	loadTwikooScript();
</script>

<script define:vars={{ twikooConfig }}>
	// 全局变量存储配置
	window.twikooConfigGlobal = twikooConfig;
	
	// 等待Twikoo脚本加载完成后初始化
	function waitForTwikooAndInit() {
		let attempts = 0;
		const maxAttempts = 20; // 最多等待10秒
		
		function checkAndInit() {
			attempts++;
			
			// 检查容器是否存在
			const container = document.getElementById('tcomment');
			if (!container) {
				console.error('Twikoo 容器未找到');
				return;
			}

			// 检查 Twikoo 是否加载
			if (typeof window.twikoo !== 'undefined') {
				console.log('Twikoo 脚本已加载，开始初始化');
				initTwikoo();
			} else if (attempts < maxAttempts) {
				console.log(`等待Twikoo脚本加载... (${attempts}/${maxAttempts})`);
				setTimeout(checkAndInit, 500);
			} else {
				console.error('Twikoo 脚本加载超时');
				handleError(new Error('Twikoo 脚本加载超时'));
			}
		}
		
		checkAndInit();
	}

	// 初始化 Twikoo
	function initTwikoo() {
		const container = document.getElementById('tcomment');
		if (!container) {
			console.error('Twikoo 容器未找到');
			return;
		}

		try {
			console.log('开始初始化Twikoo，环境ID:', window.twikooConfigGlobal.envId);
			
			window.twikoo.init({
				envId: window.twikooConfigGlobal.envId,
				el: '#tcomment',
				path: location.pathname,
				lang: 'zh-CN',
				onCommentLoaded: function () {
					console.log('Twikoo 评论加载完成');
				},
				onError: function (error) {
					console.error('Twikoo 初始化错误:', error);
					handleError(error);
				}
			}).catch(error => {
				console.error('Twikoo init promise 错误:', error);
				handleError(error);
			});
		} catch (error) {
			console.error('Twikoo 初始化异常:', error);
			handleError(error);
		}
	}

	function handleError(error) {
		console.error('Twikoo 错误:', error);
		const container = document.getElementById('tcomment');
		if (container) {
			container.innerHTML = `
				<div style="text-align: center; padding: 2rem; color: var(--content-text-color); border: 1px dashed var(--line-divider); border-radius: 12px; background: var(--card-bg);">
					<p style="margin-bottom: 0.5rem;">💬 评论系统暂时无法加载</p>
					<p style="font-size: 0.875rem; opacity: 0.7;">请检查网络连接或稍后重试</p>
					<p style="font-size: 0.75rem; opacity: 0.5; margin-top: 1rem;">环境ID: ${window.twikooConfigGlobal.envId}</p>
					<button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 0.5rem; cursor: pointer;">重新加载</button>
				</div>
			`;
		}
	}

	// 页面加载完成后开始等待和初始化
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', waitForTwikooAndInit);
	} else {
		waitForTwikooAndInit();
	}

	// 支持 Swup 页面切换
	const setup = () => {
		window.swup?.hooks.on('page:view', () => {
			const container = document.getElementById('tcomment');
			if (container) {
				container.innerHTML = '<div style="text-align: center; padding: 1rem; color: var(--content-text-color);">正在加载评论系统...</div>';
				setTimeout(waitForTwikooAndInit, 300);
			}
		});
	};

	if (window?.swup?.hooks) {
		setup();
	} else {
		document.addEventListener('swup:enable', setup);
	}
</script>